# Tokens and CLI tools

## Overview

Authentication can be done using Az Powershell or AzureAD module.

## Conditional Access Policy

Policies created to enforce security when some conditions are met :

<figure><img src="../../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

For instance, a conditional access policy can block a Azure AD login from an unknown computer.

This can be bypassed using token based authentication

## Az PowerShell

### Access token for resource manager (ARM)

> _**Must be connected to a tenant. Basically it is useful with you have compromised a host where the user is already logged in.**_

#### Request an access token

```powershell
Get-AzAccessToken
# formated output
(Get-AzAccessToken).Token
```

#### Authenticate using the token

> If an attacker is able to generate or steal a token, he'll able to login from an untrusted computer.

```powershell
# Usage 
Connect-AzAccount -AccountId test@domain.onmicrosoft.com -AccessToken ey<SNIP>..
```

#### Request an access token for a resource

> An additional resource token is required to access to specific resources.
>
> For instance, a logged user cannot enumerate other users without requesting a MSGraph token

```powershell
# Request a token for a specific resource

Get-AzAccessToken -ResourceTypeName MSGraph

# for older version
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token
```

### Stealing Tokens from Az PowerShell

> Older version of Az Powershell used to store access tokens in clear text in **TokenCache.dat** in the directory C:\Users\[username].Azure
>
> Sometimes, ServicePrincipalSecret **password** (in clear-text) can be retrieve from the AzureRmContext.json file.

> Note that it is also possible to use **SysInternal tools process dump** to retrive token from  PowerShell process.
>
> Search in the powershell Command history ; "Save-AzContext" is sometimes be used by users.

## Az CLI

> Az CLI can be used to get a token but is unable to use it.
>
> az cli is storing information into the C:\Users\polo\\.azure **"accessTokens.json"** and **"azureProfile.json"**
>
>

```powershell
# Request an access token

az account get-access-token

# Request a token for a specific resource Type (e.g. aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms

az account get-access-token --resource-type ms-graph
```

## AzureAD module

* cannot request an access token but can use them :&#x20;

```powershell
Connect-AzureAD -AccountId test@domain.onmicrosoft.com -AadAccessToken ey...
```

## Using Tokens with APIs

### Azure Resource Manager - management.azure.com



```powershell
# Request a token
(Get-AzAccessToken).Token

# Use the token on the ARM API:

$token = "<ACCESS TOKEN>
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

### Microsoft Graph - graph.microsoft.com

```powershell
# Request a token
(Get-AzAccessToken -ResourceTypeName MSGraph).Token

# Use the token on the ARM API:

$token = "<MSGraph TOKEN>
$URI = 'https://graph.microsoft.com/v1.0/users'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
