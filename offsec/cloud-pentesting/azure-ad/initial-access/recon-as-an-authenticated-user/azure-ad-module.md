# Azure AD module

## User situation via portal.azure.com

> After login, search for the user in the Active Directory panel and retrieve "Assigned roles"

![](<../../../../../.gitbook/assets/image (4).png>)

> Next, enumerate users, groups, devices, directory roles and enterprise applications

## Azure AD module&#x20;

> AzureAD module must be used to manage Azure AD. It doesn't work with Azure resources

* Install the module

`install-module AzureAD`

* connect

```python
#$creds = Get-Credentials

or

$passwd = ConvertTo-SecureString "superPassword" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@comp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
```

### User related Enumeration

* get tenant details

```powershell
 Get-AzureADTenantDetail
```

* Retrieve current session state

```powershell
Get-AzureADCurrentSessionInfo
```

* enumerate all users

`Get-AzureADUser -All $true`

* enumerate one specific user

```powershell
Get-AzureADUser -ObjectId test@company.onmicrosoft.com
```

* search for a service principal name or username which starts with XXXX

`Get-AzureADUser -SearchString "admin"`

* Search for a users who contains "admin" in their display name

```powershell
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"}
```



* Search all attributes for a user

```powershell
Get-AzureADUser -ObjectId test@comp.onmicrosoft.com | fl *
```

* Search for all attributes can contains one specific char/word (eg password)

```powershell
Get-AzureADUser -All $true |%{$Properties =$_;$Properties.PSObject.Properties.Name | % {if($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ -$($Properties.$_)"}}}
```

* Search for all users which are synced On-Premise

```powershell
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```

* Search for all users which are from Azure AD

```powershell
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```

* Search for objects created by a specific user

```powershell
 Get-AzureADUser -ObjectId test@comp.onmicrosoft.com | Get-AzureADUserCreatedObject
```

* Objects owned by a specific user

> Good way to check if a user owns a "Service Principal".
>
>

```powershell
Get-AzureADUserOwnedObject -ObjectId test@comp.onmicrosoft.com
```

### Groups related Enumeration

* Get groups

`Get-AzureADGroup -All $true`

* Specific group

`Get-AzureADGroup -ObjectId <ID>`

* Group which has "a specific string" in the DisplayName

`Get-AzureADGroup -SearchString "admin" | fl *`

* Groups can contain "admin" in their name

```powershell
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"}
```

* Get Groups that allow Dynamic membership (Note the cmdlet name)&#x20;

[`Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}`](#user-content-fn-1)[^1]

* All groups that are synced from on-prem&#x20;

```powershell
Get-AzureADGroup -All $true | ?{$.OnPremisesSecurityIdentifier -ne $null} e
```

_• All groups that are from Azure AD_&#x20;

```powershell
Get-AzureADGroup -All $true | ?{$.OnPremisesSecurityIdentifier -eq $null}
```

* Get group members of a group

```powershell
Get-AzureADGroupMember -ObjectId <ID>
```

* Get groups and roles where the specified user is a member

`Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership`

### Roles enumeration

* Get all available role templates

Get-AzureADDirectoryroleTemplate

* Get all enabled roles

```powershell
Get-AzureADDirectoryRole
```

* Enumerate users to whom roles are assigned (Ex: search for users which are admin)

```powershell
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
```

### Azure Devices

* Get all Azure joined and registered devices&#x20;

`Get-AzureADDevice -All $true | fl *`

* Retrieve the "Active" devices (based on logon)

```powershell
 Get-AzureADDevice -All $true | select DisplayName,ApproximateLastLogonTimeStamp
```

* Save with some filtering :&#x20;

```powershell
 Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
```

* Retrieve devices configuration

`Get-AzureADDeviceConfiguration | fl *`

* List Registered owners of all the devices

```powershell
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId
$_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
```

* List Registered users of all the devices

```powershell
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId
$_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
```

* List devices owned by a user&#x20;

`Get-AzureADUserOwnedDevice -ObjectId polo.polo@comp.onmicrosoft.com`

* List devices registered by a user&#x20;

`Get-AzureADUserRegisteredDevice -ObjectId polo.polo@comp.onmicrosoft.com`&#x20;

* List devices managed using Intune&#x20;

`Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}`

### Apps Enumeration

* Get owner of an application

```powershell
Get-AzureADApplication -All $true
```

* Search for an app which contains the word "app"

```powershell
Get-AzureADApplication -All $true | ?{$_.DisplayName -match "app"}
```

* And get more details on a specific application

```powershell
Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-
155a069ebed0 | fl *
```

* List all the apps with an application password

> A password protected (certificat or creds) on a App is used to connect the app on the tenant. If somehow (exploiting the application )we can retrieve those and login on the tenant impersonating the application.&#x20;

![](<../../../../../.gitbook/assets/image (2).png>)

```powershell
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
```

* Get owner of an application&#x20;

```powershell
Get-AzureADApplication -ObjectId <APP ID> | Get-AzureADApplicationOwner |fl * 
```

* •Get Apps where a User has a role (exact role is not shown)&#x20;

```powershell
Get-AzureADUser -ObjectId testuser@comp.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl * 
```

• Get Apps where a Group has a role (exact role is not shown)&#x20;

```powershell
Get-AzureADGroup -ObjectId <APP ID> | Get-AzureADGroupAppRoleAssignment | fl *rs
```

### Service Principals

> Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). Service principal is local representation for an app in a specific tenant and it is the security object that has privileges. This is the 'service account'! Service Principals can be assigned Azure roles.

* Retrieve Services Principals

```powershell
Get-AzureADServicePrincipal -All $true
```

* Get more details about a specific Service Principal

```powershell
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264
| fl *
```

* Retrieve a Service Principal searching by his name

```powershell
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"}
```

* Get Service Principal details

```powershell
Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264
| fl *
```

* Get an service principal based on the display name

```powershell
 Get-AzureADServicePrincipal -All $true | ?{$.DisplayName -match "app"} 
```

* _List all the service principals with an application password_&#x20;

```powershell
Get-AzureADServicePrincipal -All $true | %{if(Get-AzureADServicePrincipalKeyCredential - ObjectID $.ObjectID){$_}}rs
```

* Get owner of a service principal&#x20;

```powershell
Get-AzureADServicePrincipal -ObjectId <objectID> | Get-AzureADServicePrincipalOwner |fl * 
```

* Get objects owned by a service principal&#x20;

```powershell
Get-AzureADServicePrincipal -ObjectId <objectID> | Get-AzureADServicePrincipalOwnedObject we
```

* Get objects created by a service principal&#x20;

```powershell
Get-AzureADServicePrincipal -ObjectId <objectID> | Get-AzureADServicePrincipalCreatedObject
```

* Get group and role memberships of a service principal&#x20;

```powershell
Get-AzureADServicePrincipal -ObjectId <objectID> | Get- AzureADServicePrincipalMembership |fl *
```



[^1]: 
