# Recon as an authenticated user

## User situation via portal.azure.com

> After login, search for the user in the Active Directory panel and retrieve "Assigned roles"

![](<../../../../.gitbook/assets/image (4).png>)

> Next, enumerate users, groups, devices, directory roles and enterprise applications

## Azure AD module&#x20;

> AzureAD module must be used to manage Azure AD. It doesn't work with Azure resources

* Install the module

`install-module AzureAD`

* connect

```python
#$creds = Get-Credentials

or

$passwd = ConvertTo-SecureString "superPassword" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@defcorphq.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
```

### User related Enumeration

* get tenant details

```powershell
 Get-AzureADTenantDetail
```

* Retrieve current session state

```powershell
Get-AzureADCurrentSessionInfo
```

* enumerate all users

`Get-AzureADUser -All $true`

* enumerate one specific user

`Get-AzureADUser -ObjectId test@company.onmicrosoft.com`

* search for a service principal name or username which starts with XXXX

`Get-AzureADUser -SearchString "admin"`

* Search for a users who contains "admin" in their display name

`Get-AzureADUser -All $true |?{$_.Displayname -match "admin"}`



* Search all attributes for a user

```powershell
Get-AzureADUser -ObjectId test@comp.onmicrosoft.com | fl *
```

* Search for all attributes can contains one specific char/word (eg password)

```powershell
Get-AzureADUser -All $true |%{$Properties =$_;$Properties.PSObject.Properties.Name | % {if($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ -$($Properties.$_)"}}}
```

* Search for all users which are synced On-Premise

```powershell
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
```

* Search for all users which are from Azure AD

```powershell
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
```

* Search for objects created by a specific user

```powershell
 Get-AzureADUser -ObjectId test@comp.onmicrosoft.com | Get-AzureADUserCreatedObject
```

* Objects owned by a specific user

> Good way to check if a user owns a "Service Principal".
>
>

```powershell
Get-AzureADUserOwnedObject -ObjectId test@comp.onmicrosoft.com
```

### Groups related Enumeration

* Get groups

`Get-AzureADGroup -All $true`

* Specific group

`Get-AzureADGroup -ObjectId <ID>`

* Group which has "a specific string" in the DisplayName

`Get-AzureADGroup -SearchString "admin" | fl *`

* Groups can contain "admin" in their name

```powershell
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"}
```

* Get Groups that allow Dynamic membership (Note the cmdlet name)&#x20;

[`Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}`](#user-content-fn-1)[^1]

* All groups that are synced from on-prem&#x20;

`Get-AzureADGroup -All $true | ?{$`_`.OnPremisesSecurityIdentifier -ne $null}`_&#x20;

_â€¢ All groups that are from Azure AD_&#x20;

_`Get-AzureADGroup -All $true | ?{$`_`.OnPremisesSecurityIdentifier -eq $null}`

* Get group members of a group

`Get-AzureADGroupMember -ObjectId 783a312d-0de2-4490- 92e4-539b0e4ee03e`

* Get groups and roles where the specified user is a member

`Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership`

### Roles enumeration

* Get all available role templates

Get-AzureADDirectoryroleTemplate

* Get all enabled roles

```
Get-AzureADDirectoryRole
```

* Enumerate users to whom roles are assigned&#x20;

`Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember`

[^1]: 
