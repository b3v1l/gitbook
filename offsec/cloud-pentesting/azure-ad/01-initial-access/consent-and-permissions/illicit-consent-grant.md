# Illicit Consent Grant

## Attack path overview

Illicit consent Grant is the most common attack on Azure.

<figure><img src="../../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

## Methodology

* As an attacker, create a tenant (even using the free registration)
* &#x20;Use "App registration" to create a malicious App
* Send the link to a victim
* Victim grant consent to the app and an authorization response will be sent to the attacker app, containing an access token
* Attacker can use the access token to access any service on the target tenant, such as MSGraph

## Implementation

* Register a new app from Azure AD

<figure><img src="../../../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

* Next, create a client secret and save it

<figure><img src="../../../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

* Add API permission for MSGraph API

<figure><img src="../../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

* Grant "Delegated Permission" to access the MSGraph using the target victim account and add User.ReadBasicAll (Low impact, no admin consent needed\*) permission

<figure><img src="../../../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

> In case of already getting a foothold in the target tenant (eg compromised host), it is possible to verify the Consent Grant policy. Otherwise, it is not possible, we just have to blindly test it&#x20;

```powershell
# import AzureAD-Preview powershell module

Import-Module .\AzureADPreview.psd1

# check policy
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole

# if it returns ManagePermissionGrantsForSelf.microsoft-user-default-legacy, it means tha
# the user can grant consent to all apps
```
