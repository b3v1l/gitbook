# Illicit Consent Grant

## Attack path overview

Illicit consent Grant is the most common attack on Azure.

<figure><img src="../../../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

## Methodology

* As an attacker, create a tenant (even using the free registration)
* &#x20;Use "App registration" to create a malicious App
* Send the link to a victim
* Victim grant consent to the app and an authorization response will be sent to the attacker app, containing an access token
* Attacker can use the access token to access any service on the target tenant, such as MSGraph

## Implementation

* Register a new app from Azure AD

<figure><img src="../../../../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

* Next, create a client secret and save it

<figure><img src="../../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

* Add API permission for MSGraph API

<figure><img src="../../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

* Grant "Delegated Permission" to access the MSGraph using the target victim account and add User.ReadBasicAll (Low impact, no admin consent needed\*) permission

<figure><img src="../../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

> In case of already getting a foothold in the target tenant (eg compromised host), it is possible to verify the Consent Grant policy. Otherwise, it is not possible, we just have to blindly test it&#x20;

```powershell
# import AzureAD-Preview powershell module

Import-Module .\AzureADPreview.psd1

# check policy
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole

# if it returns ManagePermissionGrantsForSelf.microsoft-user-default-legacy, it means tha
# the user can grant consent to all apps
```

## Weaponize the App

> Diffenrent tools can be used to steal token :&#x20;
>
> * MDSEC o365-attack-toolkit
> * AlteredSec 365-Stealer **(just a POC, don't use that in PROD)**
>
>

### o365-attack-toolkit

TODO...

{% embed url="https://github.com/mdsecactivebreach/o365-attack-toolkit" %}

### 365-Stealer

{% embed url="https://github.com/AlteredSecurity/365-Stealer" %}

* clone the tool
* copy the directory into a the web server root (htdocs for windows)
* start Apache and browse into the 365-Stealer page

<figure><img src="../../../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

* configure the tool using the "Registered App" ClientID and Secret and the Redirect URI

<figure><img src="../../../../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

* Start 365-Stealer and retrieve the Phishing link

<figure><img src="../../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

* Send the malicious link to the victim

<figure><img src="../../../../../.gitbook/assets/image (43).png" alt=""><figcaption></figcaption></figure>

> Reminder about the different parameters

<figure><img src="../../../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

* retrieve the token

<figure><img src="../../../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (15).png" alt=""><figcaption><p>Access Token !</p></figcaption></figure>

* decoding the token

<figure><img src="../../../../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

* use the token and make queries on MSGraph

```powershell
$token = "<Stolen Token>"
$URI = 'https://graph.microsoft.com/v1.0/users'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

> Note: The malicious Registered App has now been added to the target Tenant, under Enterprise Applications
>
>

<figure><img src="../../../../../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>
