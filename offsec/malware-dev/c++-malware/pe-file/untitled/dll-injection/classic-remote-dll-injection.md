# Classic Remote DLL injection

## Classic Remote DLL injection

### DLL C++ main code

Code contains :

* the payload and his size
* An exportable function \(go\) `extern __declspec(dllexport) int Go(void);`
  * The function allocate a buffer \(RW\) using `VirtualAlloc`
  * Copy the payload in the buffer using `RtlMoveMemory(my_buffer, payload, payload_len);`
  * Change the protectio using `VirtualProtect` and set it to Exec and Read
  * Launch everything using `CreateThread`

#### DLL main function \(DLL process\_attach -&gt; function\)

```cpp
BOOL WINAPI DllMain( HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved ) {

    switch ( fdwReason ) {
            case DLL_PROCESS_ATTACH:
                    Go();
                    break;
            case DLL_THREAD_ATTACH:
                    break;
            case DLL_THREAD_DETACH:
                    break;
            case DLL_PROCESS_DETACH:
                    break;
            }
    return TRUE;
}
```

### Injector code

* Use SearchProcess and returns the pid of the target process
* Get the local `pLoadLibrary` in kernel32.dll using GetProcAddress
* Open the target process \(pHandle\)
* Remote Buffer allocation using `VirtualAllocEx` with the dll size
* Write the DLL path using `WriteProcessMemory`
* Call `LoadLibrary` and point it to the DLL path into the remote process using `CreateRemoteThread`

