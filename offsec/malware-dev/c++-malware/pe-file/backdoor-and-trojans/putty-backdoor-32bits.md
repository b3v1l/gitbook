# Putty backdoor \(32bits\)

## Putty backdoor \(32bits\)

32bits application = 32bits debugger ...

### Search for code cave

* Open the file \(open not attach\) in the 32bits debugger
* Since we are in text section, we can usually find space at the end

![](../../../../../.gitbook/assets/01c9e2f37ed84984b8f77631d6120f3d.png)

![](../../../../../.gitbook/assets/12f0a80d7354496897bdb97b9efe85d0.png)

* Set a breakpoint into the code cave start \(XXXXXX961\)

![](../../../../../.gitbook/assets/399b20a5503345658285c35307a75dfe.png)

### Create/add a jmp instruction

* From putty first entry point, we need to create a jmp to reach the code cave \(backup putty instruction first\):

  ```text
  00454AD0 | 6A 60                            | push 60                              
  00454AD2 | 68 B07A4700              | push putty.477AB0                    
  00454AD7 | E8 08210000              | call putty.456BE4                    
  00454ADC | BF 94000000              | mov edi,94             
  00454AE1 | 8BC7                             | mov eax,edi
  ```

* Use Assemble and create the jmp suting the code cave address

![](../../../../../.gitbook/assets/2a95dd85272c4972ae2016a6e6780271.png)

![](../../../../../.gitbook/assets/4c5532e102584404a820c81958f3fa6d.png)

### Add pushad and pushfd

* To avoid change in the program, we need to save all the registers values and flags values.

![](../../../../../.gitbook/assets/e3ff1140be0847f1a3ce431bcf655ccf.png)

### Add shellcode

* Select empty space:

![](../../../../../.gitbook/assets/9643ce0556b94d2aa6e1bd36e33bce8f.png)

![](../../../../../.gitbook/assets/669cb296cb9d440081102af689f6838e.png)

* Create a 32 bits shellcode in C format, select the empty space and select Binaries -&gt; edit. Then, paste the shellcode.

![](../../../../../.gitbook/assets/80ac5e008bea4535b3e70bd8db57007f.png)

### Patch file

* Right click, patch, select all. Create a new exe patched file:

![](../../../../../.gitbook/assets/4e5f960e7c7148759494db59302209e1.png)

* Get a shell \(putty doesn't run BTW ...\)

![](../../../../../.gitbook/assets/eb52de98512a4346ad29e8f337cb3390.png)

### Search the exit code

* Set a breakpoint on ANY shellcode call instruction :

![](../../../../../.gitbook/assets/8f2d96c92bd3444f9f7387ae9a1e38cd.png)

* Find the last Call before the program exits.
* From there, select the previous push 0 instructionand replace it by a jmp into a new empty space
* From there, restore flads and registry values using popfd and popad instructions
* Next, retrieve putty register instructions, select few lines into the free memory and copy the hex values:

00454AD0 \| 6A 60 \| push 60  
00454AD2 \| 68 B07A4700 \| push putty.477AB0  
00454AD7 \| E8 08210000 \| call putty.456BE4

**6A 60 68 B0 7A 47 00**

* Last step is to create a jmp into the putty call instruction \(ie 00454AD7\)

![](../../../../../.gitbook/assets/887eb7902ca042bba6752f3fe2396298.png)

![](../../../../../.gitbook/assets/4e2c164bb0ed4744a8fd7bef07fecdfd.png)

