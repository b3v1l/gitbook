# Unhooking with Frida

## Unhooking with Frida

### About

Hook Win32 APIs through a Python backend while using JavaScript to display and interpret arguments and return values.

### Install

```text
C:\Users\b3v1l> pip install frida-tools
```

### Usage

#### frida-trace:

```text
-p pid
-x dll
-i Specific search
```

![](../../../.gitbook/assets/image%20%2866%29.png)

 **-  type something in the powershell console.**

 ex: test

{% hint style="info" %}
Files are created in the current directory:
{% endhint %}

![](../../../.gitbook/assets/image%20%2879%29.png)

- Edit `AmsiScanBuffer.js`

```csharp
onEnter: function (log, args, state) {
 log('[*] AmsiScanBuffer()');
 log('|- amsiContext: ' + args[0]);
 log('|- buffer: ' + Memory.readUtf16String(args[1]));
 log('|- length: ' + args[2]);
 log('|- contentName ' + args[3]);
 log('|- amsiSession ' + args[4]);
 log('|- result ' + args[5] + "\n");
 this.resultPointer = args[5];
 },


 //onEnter(log, args, state) {
 // log('AmsiScanBuffer()');
 //},

 /**
 * Called synchronously when about to return from AmsiScanBuffer.
 *
 * See onEnter for details.
 *
 * @this {object} - Object allowing you to access state stored in onEnter.
 * @param {function} log - Call this function with a string to be presented to the user.
 * @param {NativePointer} retval - Return value represented as a NativePointer object.
 * @param {object} state - Object allowing you to keep state across function calls.
 */

 onLeave: function (log, retval, state) {
 log('[*] AmsiScanBuffer() Exit');
 resultPointer = this.resultPointer;
 log('|- Result value is: ' + Memory.readUShort(resultPointer) + "\n");


```

![](../../../.gitbook/assets/image%20%28230%29.png)

### "Malicious" Flag

![](../../../.gitbook/assets/image%20%28157%29.png)

### Resouces

{% embed url="https://www.python.org/downloads/" %}

{% embed url="https://frida.re/docs/installation/" %}

