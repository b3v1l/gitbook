# Malware in a nutshell

## Malware in a nutshell

### Overview

#### Classic &lt;stager&gt; acts as the following :

* Allocate memory \(length of the shellcode\) to inject the shellcode
* Shellcode is written in memory 
* Create a threat to execute the shellcode into the current process
* Keep the current thread alive

### Classic Windows API

#### Local Process Injection 

1. **VirtualAlloc :** allocate the memory within the current process using the shellcode size and then, adjust permissions on the memory space \(RWX\)
2. **RtlMoveMemory:** copy the shellcode into the allocate memory
3. **CreateThread:** Create a thread which will execute the shellcode
4. **WaitForSingleObject:** Force the current thread to stay alive until the new created thread exits

#### Remote Process Injection 

1. **CreateProcess:** spawn a new process
2. **VirtualAllocEx**: allocate memory in the newly created Process. Assigns memory permissions
3. **WriteProcessMemory**: copy the shellcode into the remote process
4. **VirtualProtectEx**: Change memory permissions associated with a range of memory allocated with VirtualAllocEx in a remote process
5. **CreateRemoteThread**: creates a thread which executes the shellcode in the remote process.

## Memory

### Memory Protection Constants

![](../../.gitbook/assets/image%20%28217%29.png)

### Local Memory Allocation Methods

![](../../.gitbook/assets/image%20%2899%29.png)

#### VirtualAlloc RWX issue

In a nutshell, AV products are able to detect move like set RWX on memory.

The idea was to avoid that by using **VirtualProtect**.

**VirtualProtect**

The idea is the same :

* **VirtualAlloc** allocate memory for the shellcode and set permission to Read and Write \(RW\).
* **RltMoveMemory** copy the shell code into the allocated mem
* **VirtualProtect** set the memory space allocated by VirtualAlloc to Execute **ONLY** \(X\)
* **CreateThread** execute the shellcode in the current process
* **WaitForSingleObject** wait for the CreatedThread to finish before exiting

Note: this behavior is now also flagged.

#### HeapAlloc & HeapCreate

* **HeapCreate** is responsible to set permission on the allocate memory space. RW is the default so we need to set it up to RWX or execution is not possible.
* **HeapAlloc** is responsible to allocate the memory space into the Heap.

### Remote Memory Allocation Methods

Inject code into a remote process

* **VirtualAllocEx**: allocate memory into a remote process and set memory permissions
* **WriteProcessMemory**: copy the code into the allocated remote processÂ´s memory
* **CreateRemoteThread**: Creates a thread in the remote process to run the injected code

## Windows API Call resources

### Microsoft documentation

{% embed url="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants" %}

### Pinvoke

Pinvoke is probably the best resource to get information about specific Windows API calls :

![](../../.gitbook/assets/image%20%28204%29.png)

{% embed url="http://pinvoke.net/" %}

### Github etc ...

![](../../.gitbook/assets/image%20%28192%29.png)

